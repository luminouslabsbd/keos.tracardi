var jsonUrls =
    '[{"id":6,"domain_id":4,"url":"Sint temporibus cor","action":"client","role":"organizer","event_name":"Tyler Herman","event_type":"click","button_id":"asdas"}]';

function checkUrlRoleMapping() {
    var currentUrl = window.location.href;
    console.log(jsonUrls);
    for (var i = 0; i < jsonUrls.length; i++) {
        var mapping = jsonUrls[i];
        if (
            jsonUrls[i]?.url === currentUrl &&
            jsonUrls[i]?.event_type == "view"
        ) {
            console.log("This is view event on page load");
            // Function to load the script dynamically
            function loadScript(url, callback) {
                var script = document.createElement("script");
                script.type = "text/javascript";
                script.src = url;
                script.onload = callback;
                document.head.appendChild(script);
            }

            function scriptLoaded() {
                console.log("Script loaded successfully");
                window.tracker.track(jsonUrls[i]?.event_name, {
                    Type: jsonUrls[i]?.event_type,
                    Role: jsonUrls[i]?.role,
                    Action: jsonUrls[i]?.action,
                });
            }

            loadScript(
                "http://localhost/assets/js/eventosd.tracardi.js",
                scriptLoaded
            );

            // return mapping.role;
        }
    }
    // Keep track of clicked buttons
    var clickedButtons = new Set();
    jsonUrls.forEach(function (item) {
        if (item.url === currentUrl && item.event_type === "click") {
            if (!clickedButtons.has(item.button_id)) {
                var button = document.getElementById(item.button_id);
                if (button) {
                    button.addEventListener("click", function () {
                        if (!clickedButtons.has(item.button_id)) {
                            clickedButtons.add(item.button_id);

                            function loadScript(url, callback) {
                                var script = document.createElement("script");
                                script.type = "text/javascript";
                                script.src = url;
                                script.onload = callback;
                                document.head.appendChild(script);
                            }

                            function scriptLoaded() {
                                console.log("Script loaded successfully");
                                window.tracker.track(item.event_name, {
                                    Type: mapping.event_type,
                                    Role: mapping?.role,
                                    Action: mapping?.action,
                                });
                            }

                            loadScript(
                                "http://localhost/assets/js/eventosd.tracardi.js",
                                scriptLoaded
                            );
                            console.log("Button clicked:", item);
                        }
                    });
                }
            }
        }

        if (item.url === currentUrl && item.event_type === "submit") {
            if (!clickedButtons.has(item.button_id)) {
                var button = document.getElementById(item.button_id);
                if (button) {
                    button.addEventListener("click", function () {
                        event.preventDefault();

                        var form = button.closest("form");
                        var formData = {};
                        Array.from(form.elements).forEach(function (element) {
                            if (
                                element.name &&
                                (element.tagName === "INPUT" ||
                                    element.tagName === "SELECT" ||
                                    element.tagName === "TEXTAREA")
                            ) {
                                formData[element.name] = element.value;
                            }
                        });
                        console.log("Form Data:", formData);
                        if (!clickedButtons.has(item.button_id)) {
                            clickedButtons.add(item.button_id);
                            function loadScript(url, callback) {
                                var script = document.createElement("script");
                                script.type = "text/javascript";
                                script.src = url;
                                script.onload = callback;
                                document.head.appendChild(script);
                            }

                            function scriptLoaded() {
                                console.log("Script loaded successfully");
                                window.tracker.track(item.event_name, {
                                    Type: mapping.event_type,
                                    Role: mapping?.role,
                                    Action: mapping?.action,
                                    FormData: formData,
                                });
                            }

                            loadScript(
                                "http://localhost/assets/js/eventosd.tracardi.js",
                                scriptLoaded
                            );

                            console.log("Button clicked:", item);
                        }
                    });
                }
            }
        }
    });
    console.log("No matching role found for URL: " + currentUrl);
}

// Function to check if event origin exists in JSON data URLs
function isEventOriginInJsonData(eventOrigin) {
    // Check if event origin exists in any of the URLs in JSON data
    return jsonUrls.some((item) => item.url.startsWith(eventOrigin));
}
// Function to handle messages from child apps
function handleMessageFromChild(event) {
    const messageData = event.data;
    // Check if the message is from an allowed origin
    if (isEventOriginInJsonData(window.location.href)) {
        if (messageData.type === "FormSubmit") {
            console.log(
                "Received message from child:",
                window.location.href,
                "-------- origin"
            );
            function loadScript(url, callback) {
                var script = document.createElement("script");
                script.type = "text/javascript";
                script.src = url;
                script.onload = callback;
                document.head.appendChild(script);
            }

            function scriptLoaded() {
                console.log("Script loaded successfully");
                window.tracker.track("Form submit event", {
                    FormData: event.data,
                });
            }

            loadScript(
                "http://localhost/assets/js/test.tracardi.js",
                scriptLoaded
            );
        }
    } else {
        console.log("Event origin is not allowed:", window.location.href);
    }
}
// Listen for messages from child apps
window.addEventListener("message", handleMessageFromChild);
